version: '3'
services:
  # 1. IL BROKER MQTT (Edge Layer)
  mosquitto:
    image: eclipse-mosquitto:2
    container_name: mosquitto
    ports:
      - "1883:1883"     # Porta per il tuo script Python
      - "9001:9001"     # Porta Web (utile per debug)
    volumes:
      - ./mosquitto.conf:/mosquitto/config/mosquitto.conf
    networks:
      - digital-twin-net

  # 2. KAFKA (Ingestion Layer) - Usiamo Redpanda (compatibile Kafka, pi√π leggero)
  kafka:
    image: docker.io/redpandadata/console:latest
    container_name: kafka-console
    depends_on:
      - redpanda
    ports:
      - "8080:8080" # UI Web per vedere i messaggi Kafka
    environment:
      KAFKA_BROKERS: redpanda:9092
    networks:
      - digital-twin-net

  redpanda:
    image: docker.io/redpandadata/redpanda:latest
    container_name: kafka-broker
    command:
      - redpanda start
      - --smp 1
      - --memory 1G
      - --reserve-memory 0M
      - --overprovisioned
      - --node-id 0
      - --check=false
      - --kafka-addr PLAIN://0.0.0.0:9092,OUTSIDE://0.0.0.0:29092
      - --advertise-kafka-addr PLAIN://redpanda:9092,OUTSIDE://localhost:29092
    ports:
      - "29092:29092" # Porta per connetterci da fuori se serve
    networks:
      - digital-twin-net
      
  dashboard:
    build: ./dashboard      # Costruisce l'immagine dalla cartella dashboard
    container_name: dashboard-service
    ports:
      - "3000:3000"         # Espone la porta Web all'esterno
    environment:
      - KAFKA_BROKER=redpanda:9092  # Dice a Node di usare l'indirizzo interno
    depends_on:
      - redpanda            # Aspetta che Kafka sia pronto
    networks:
      - digital-twin-net

networks:
  digital-twin-net:
    driver: bridge